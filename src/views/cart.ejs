<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết Giỏ hàng</title>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,700" rel="stylesheet">

	<!-- Bootstrap -->
	<link type="text/css" rel="stylesheet" href="/css/bootstrap.min.css" />

	<!-- Slick -->
	<link type="text/css" rel="stylesheet" href="/css/slick.css" />
	<link type="text/css" rel="stylesheet" href="/css/slick-theme.css" />

	<!-- nouislider -->
	<link type="text/css" rel="stylesheet" href="/css/nouislider.min.css" />

	<!-- Font Awesome Icon -->
	<link rel="stylesheet" href="/css/font-awesome.min.css">

	<!-- Custom stlylesheet -->
	<link type="text/css" rel="stylesheet" href="/css/style.css" />
</head>
<body>
    <%- include('./header.ejs') %>
    <div class="container py-5">
        <div class="row">
            <div class="col-12">
                <h1 class="section-title">Chi tiết giỏ hàng</h1>
            </div>
        </div>
        
        <div class="row">
            <div class="col-lg-8">
                <!-- Danh sách sản phẩm trong giỏ hàng -->
                <div class="cart-items">
                 
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <img src="/api/placeholder/100/100" alt="Sản phẩm 1" class="product-image">
                            </div>
                            <div class="col-md-4">
                                <h5>Áo thun nam basic</h5>
                                <p class="text-muted mb-0">Màu: Trắng / Size: L</p>
                            </div>
                            <div class="col-md-2">
                                <span class="product-price">250,000₫</span>
                            </div>
                            <div class="col-md-3">
                                <div class="quantity-control">
                                    <div class="quantity-btn minus">-</div>
                                    <input type="text" class="quantity-input" value="1" min="1">
                                    <div class="quantity-btn plus">+</div>
                                </div>
                            </div>
                            <div class="col-md-1 text-end">
                                <i class="fas fa-trash remove-item"></i>
                            </div>
                        </div>
                    </div>
                
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="input-group coupon-group">
                            <input type="text" class="form-control coupon-input" placeholder="Mã giảm giá">
                            <button class="btn btn-outline-primary" type="button">Áp dụng</button>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-secondary me-2" id="updateCartBtn">Cập nhật giỏ hàng</button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 mt-4 mt-lg-0">
                <div class="cart-summary">
                    <h4 class="mb-4">Tổng giỏ hàng</h4>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tạm tính</span>
                        <span id="subtotal">1,550,000₫</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Phí vận chuyển</span>
                        <span>30,000₫</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Giảm giá</span>
                        <span>0₫</span>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-4">
                        <span class="fw-bold">Tổng cộng</span>
                        <span class="total-price" id="totalPrice">1,580,000₫</span>
                    </div>
                    
                    <button id="checkoutButton" class="btn btn-primary w-100 checkout-btn">Tiến hành thanh toán</button>
                    
                    <div class="mt-3 text-center">
                        <a href="/" class="continue-shopping-btn">
                            <i class="fas fa-arrow-left me-2"></i>Tiếp tục mua sắm
                        </a>
                    </div>
                </div>
                
                <div class="mt-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Phương thức thanh toán</h5>
                            <div class="d-flex gap-2 mb-2">
                                <img src="/api/placeholder/40/25" alt="Visa" class="payment-icon">
                                <img src="/api/placeholder/40/25" alt="MasterCard" class="payment-icon">
                                <img src="/api/placeholder/40/25" alt="PayPal" class="payment-icon">
                                <img src="/api/placeholder/40/25" alt="Momo" class="payment-icon">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="isLoggedIn" value="<%= user ? 'true' : 'false' %>">
    <%- include('./footer.ejs') %>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
    <script>
        $(document).ready(function() {
            let cartData = JSON.parse(localStorage.getItem('cart')) || [];
        
            function formatVND(value) {
                return value.toLocaleString('vi-VN') + '₫';
            }
        
            function parseCurrency(currencyString) {
                return parseInt(currencyString.replace(/[^\d]/g, '')) || 0;
            }
        
            function formatCurrency(number) {
                return new Intl.NumberFormat('vi-VN').format(number) + '₫';
            }
        
            function renderCart() {
                const cartItemsContainer = $('.cart-items');
                cartItemsContainer.empty();
                
                if (cartData.length === 0) {
                    cartItemsContainer.html('<div class="text-center py-5"><h5>Giỏ hàng của bạn đang trống</h5><p>Hãy thêm sản phẩm vào giỏ hàng</p><a href="/" class="btn btn-outline-primary mt-3">Tiếp tục mua sắm</a></div>');
                    $('#subtotal').text('0₫');
                    $('#totalPrice').text('0₫'); 
                    return;
                }
        
                let subtotal = 0;
        
                cartData.forEach(product => {
                    subtotal += product.price * product.qty;
        
                    const itemHTML = `
                    <div class="cart-item">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <img src="${product.img}" alt="${product.name}" class="product-image">
                            </div>
                            <div class="col-md-4">
                                <h5>${product.name}</h5>
                                <p class="text-muted mb-0">Màu: Không có / Size: Không có</p>
                            </div>
                            <div class="col-md-2">
                                <span class="product-price">${formatVND(product.price)}</span>
                            </div>
                            <div class="col-md-3">
                                <div class="quantity-control">
                                    <div class="quantity-btn minus" data-name="${product.name}">-</div>
                                    <input type="text" class="quantity-input" value="${product.qty}" min="1" readonly>
                                    <div class="quantity-btn plus" data-name="${product.name}">+</div>
                                </div>
                            </div>
                            <div class="col-md-1 text-end">
                                <i class="fas fa-trash remove-item" data-name="${product.name}" style="cursor:pointer;"></i>
                            </div>
                        </div>
                    </div>
                    `;
                    cartItemsContainer.append(itemHTML);
                });
        
                const shipping = 30000;
                const discount = 0;
                const total = subtotal + shipping - discount;
        
                $('#subtotal').text(formatCurrency(subtotal));
                $('#totalPrice').text(formatCurrency(total));
            }
        
            function updateStorage() {
                localStorage.setItem('cart', JSON.stringify(cartData));
                renderCart();
            }
        
            // Sự kiện bấm nút tăng/giảm/xóa
            $(document).on('click', '.plus', function() {
                const name = $(this).data('name');
                const product = cartData.find(p => p.name === name);
                if (product) {
                    product.qty += 1;
                    updateStorage();
                }
            });
        
            $(document).on('click', '.minus', function() {
                const name = $(this).data('name');
                const product = cartData.find(p => p.name === name);
                if (product && product.qty > 1) {
                    product.qty -= 1;
                    updateStorage();
                } else if (product && product.qty === 1) {
                    if (confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
                        cartData = cartData.filter(p => p.name !== name);
                        updateStorage();
                    }
                }
            });
        
            $(document).on('click', '.remove-item', function() {
                const name = $(this).data('name');
                if (confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
                    cartData = cartData.filter(p => p.name !== name);
                    updateStorage();
                }
            });
        
            
            $('#updateCartBtn').click(function() {
                renderCart();
                showAlert('Giỏ hàng đã được cập nhật!');
            });
        
            function showAlert(message) {
                $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                  message +
                  '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                  '</div>').insertBefore('.cart-items').delay(3000).fadeOut(function() {
                    $(this).remove();
                  });
            }
        
            
            renderCart();
        });


        document.getElementById('checkoutButton').addEventListener('click', function() {
        const isLoggedIn = document.getElementById('isLoggedIn').value;

        if (isLoggedIn !== 'true') {
            alert('Bạn cần đăng nhập để tiến hành thanh toán.');
            window.location.href = '/login'; 
            return;
        }

        window.location.href = '/checkout'; 
    });
        </script>
        
</body>
</html>