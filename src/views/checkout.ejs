<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>VTVT Store - Th√¥ng tin ƒë·∫∑t h√†ng</title>

  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,700" rel="stylesheet">

  <!-- Bootstrap -->
  <link type="text/css" rel="stylesheet" href="/css/bootstrap.min.css" />

  <!-- Slick -->
  <link type="text/css" rel="stylesheet" href="/css/slick.css" />
  <link type="text/css" rel="stylesheet" href="/css/slick-theme.css" />

  <!-- nouislider -->
  <link type="text/css" rel="stylesheet" href="/css/nouislider.min.css" />

  <!-- Font Awesome Icon -->
  <link rel="stylesheet" href="/css/font-awesome.min.css">

  <!-- Custom stylesheet -->
  <link type="text/css" rel="stylesheet" href="/css/style.css" />

  <style>
    .form-group .d-flex>* {
      flex: 1;
    }

    .d-flex {
      display: flex;
      gap: 10px;
    }
  </style>

</head>

<body>

  <%- include('./header.ejs') %>

    <!-- SECTION -->
    <div class="section">
      <div class="container">
        <div class="row">

          <div class="col-md-7">
            <!-- Billing Details -->
            <div class="billing-details">
              <div class="section-title">
                <h3 class="title">ƒê·ªäA CH·ªà THANH TO√ÅN</h3>
              </div>

              <div class="form-group">
                <input class="input form-control" type="text" name="first_name" placeholder="H·ªç"
                  value="<%= customer ? customer.last_name : '' %>">
              </div>
              <div class="form-group">
                <input class="input form-control" type="text" name="last_name" placeholder="T√™n"
                  value="<%= customer ? customer.first_name : '' %>">
              </div>
              <div class="form-group">
                <input class="input form-control" type="email" name="email" placeholder="Email"
                  value="<%=(user.emails && user.emails[0] && user.emails[0].value) || user.email%>">
              </div>

              <!-- ƒê·ªãa ch·ªâ chia 3 combobox -->
              <div class="form-group">
                <input type="hidden" id="hiddenAddress" value="<%= customer ? customer.address : '' %>">
                <div class="d-flex">
                  <select class="input form-control" id="province" name="province">
                    <option value=""> T·ªânh, Th√†nh ph·ªë</option>
                  </select>
                  <select class="input form-control" id="district" name="district">
                    <option value=""> Qu·∫≠n, Huy·ªán</option>
                  </select>
                  <select class="input form-control" id="ward" name="ward">
                    <option value=""> Ph∆∞·ªùng, X√£</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <input class="input form-control" type="text" id="street" name="street" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng">
              </div>

              <div class="form-group">
                <input class="input form-control" type="tel" name="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i"
                  value="<%= customer ? customer.phone : '' %>">
              </div>

            </div>

            <!-- Order notes -->
            <div class="order-notes">
              <textarea class="input form-control" name="note" placeholder="Ghi ch√∫ ƒë∆°n h√†ng"></textarea>
            </div>
            <!-- /Order notes -->
          </div>


          <!-- Order Details -->
          <div class="col-md-5 order-details">
            <div class="section-title text-center">
              <h3 class="title">ƒê∆†N H√ÄNG C·ª¶A B·∫†N</h3>
            </div>

            <div class="order-summary">
              <div class="order-col">
                <div><strong>S·∫£n Ph·∫©m</strong></div>
                <div><strong>Th√†nh Ti·ªÅn</strong></div>
              </div>

              <div class="order-products">
                <div class="order-col">
                  <div></div>
                  <div></div>
                </div>

              </div>
              <div class="order-col">
                <div>Giao h√†ng</div>
                <div><strong>MI·ªÑN PH√ç</strong></div>
              </div>
              <div class="order-col">
                <div><strong>T·ªïng Ti·ªÅn</strong></div>
                <div><strong class="order-total"></strong></div>
              </div>
            </div>
            <div class="payment-method">
              <div class="input-radio">
                <input type="radio" name="payment" id="payment-1" value="COD">
                <label for="payment-1">
                  <span></span>
                  Thanh to√°n ti·ªÅn m·∫∑t
                </label>
              </div>
              <div class="input-radio">
                <input type="radio" name="payment" id="payment-3" value="MoMo">
                <label for="payment-3">
                  <span></span>
                  Thanh to√°n tr·ª±c tuy·∫øn
                </label>
              </div>
            </div>
            <div class="input-checkbox">
              <input type="checkbox" id="terms">
              <label for="terms">
                <span></span>
                T√¥i ƒë√£ ƒë·ªçc v√† ch·∫•p nh·∫≠n <a href="#">c√°c ƒëi·ªÅu kho·∫£n v√† ƒëi·ªÅu ki·ªán</a>
              </label>
            

            </div>
            <button id="placeOrderBtn" class="primary-btn order-submit">ƒê·∫∑t h√†ng</button>
          </div>
          <!-- /Order Details -->

        </div>
      </div>
    </div>
    <!-- /SECTION -->

    <%- include('./footer.ejs') %>

      <!-- jQuery Plugins -->
      <script src="/js/jquery.min.js"></script>
      <script src="/js/bootstrap.min.js"></script>
      <script src="/js/slick.min.js"></script>
      <script src="/js/nouislider.min.js"></script>
      <script src="/js/jquery.zoom.min.js"></script>
      <script src="/js/main.js"></script>

      <!-- ƒê·ªÉ sau n√†y fetch API t·ªânh th√†nh ƒë·ªông -->
   <script>
document.addEventListener("DOMContentLoaded", function () {
  function formatVND(value) {
    return value.toLocaleString("vi-VN") + " VNƒê";
  }

  function renderCheckout() {
    const cartData = JSON.parse(localStorage.getItem("cart")) || [];
    const container = document.querySelector(".order-products");
    const totalElement = document.querySelector(".order-total");
    const voucherDiscount = parseInt(localStorage.getItem("voucherDiscount")) || 0;
    const voucherCode = localStorage.getItem("voucherCode") || "";

    container.innerHTML = "";
    let subtotal = 0;

    cartData.forEach(product => {
      const itemSubtotal = product.price * product.qty;
      subtotal += itemSubtotal;
      container.insertAdjacentHTML("beforeend", `
        <div class="order-col">
          <div>${product.qty}x ${product.name}</div>
          <div>${formatVND(itemSubtotal)}</div>
        </div>
      `);
    });

    const discountAmount = Math.floor(subtotal * voucherDiscount / 100);
    const totalAfterDiscount = subtotal - discountAmount;

    if (voucherDiscount > 0) {
      container.insertAdjacentHTML("beforeend", `
        <div class="order-col">
          <div>Gi·∫£m gi√° ${voucherCode}</div>
          <div>- ${formatVND(discountAmount)}</div>
        </div>
      `);
    }

    totalElement.innerText = formatVND(totalAfterDiscount);
  }

  renderCheckout();

  const provinceSelect = document.getElementById("province");
  const districtSelect = document.getElementById("district");
  const wardSelect = document.getElementById("ward");

  fetch("https://provinces.open-api.vn/api/p/")
    .then(res => res.json())
    .then(provinces => {
      provinces.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.code;
        opt.textContent = p.name;
        provinceSelect.appendChild(opt);
      });
    });

  provinceSelect.addEventListener("change", () => {
    const code = provinceSelect.value;
    districtSelect.innerHTML = '<option value="">Ch·ªçn Qu·∫≠n, Huy·ªán</option>';
    wardSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng, X√£</option>';
    if (!code) return;

    fetch(`https://provinces.open-api.vn/api/p/${code}?depth=2`)
      .then(res => res.json())
      .then(data => {
        data.districts.forEach(d => {
          const opt = document.createElement("option");
          opt.value = d.code;
          opt.textContent = d.name;
          districtSelect.appendChild(opt);
        });
      });
  });

  districtSelect.addEventListener("change", () => {
    const code = districtSelect.value;
    wardSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng, X√£</option>';
    if (!code) return;

    fetch(`https://provinces.open-api.vn/api/d/${code}?depth=2`)
      .then(res => res.json())
      .then(data => {
        data.wards.forEach(w => {
          const opt = document.createElement("option");
          opt.value = w.code;
          opt.textContent = w.name;
          wardSelect.appendChild(opt);
        });
      });
  });

  const applyBtn = document.getElementById("applyVoucherBtn");
if (applyBtn) {
  applyBtn.addEventListener("click", async function (e) {
    e.preventDefault();
    const voucherInput = document.getElementById("voucherCode");
    if (!voucherInput) return;
    const voucherCode = voucherInput.value.trim();
    if (!voucherCode) {
      alert("Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°.");
      return;
    }

    try {
      const res = await fetch("/api/voucher/apply", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: voucherCode })
      });
      const data = await res.json();
      if (res.ok && data.success && data.voucher) {
        // Ch·ªâ l∆∞u voucherCode v√† voucherDiscount, kh√¥ng c·∫ßn voucherId n·ªØa
        localStorage.setItem("voucherCode", data.voucher.voucher_code);
        localStorage.setItem("voucherDiscount", data.voucher.voucher_value.toString());

        console.log("‚úÖ Voucher l∆∞u v√†o localStorage:", {
          voucherCode: data.voucher.voucher_code,
          voucherDiscount: data.voucher.voucher_value
        });

        alert("√Åp d·ª•ng voucher th√†nh c√¥ng: " + data.voucher.voucher_value + "%");
        renderCheckout();
      } else {
        alert("M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n.");
        localStorage.removeItem("voucherCode");
        localStorage.removeItem("voucherDiscount");
        renderCheckout();
      }
    } catch (err) {
      console.error("‚ùå L·ªói khi √°p d·ª•ng voucher:", err);
      alert("Kh√¥ng th·ªÉ √°p d·ª•ng voucher, vui l√≤ng th·ª≠ l·∫°i.");
    }
  });
}

const placeOrderBtn = document.getElementById("placeOrderBtn");
if (placeOrderBtn) {
  placeOrderBtn.addEventListener("click", async function (e) {
    e.preventDefault();

    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    if (cart.length === 0) {
      alert("Gi·ªè h√†ng tr·ªëng.");
      return;
    }

    // L·∫•y th√¥ng tin t·ª´ form
    const first_name = document.querySelector('[name="first_name"]')?.value.trim() || '';
    const last_name  = document.querySelector('[name="last_name"]')?.value.trim() || '';
    const street     = document.querySelector('[name="street"]')?.value.trim() || '';
    const phone      = document.querySelector('[name="phone"]')?.value.trim() || '';
    const email      = document.querySelector('[name="email"]')?.value.trim() || '';
    const note       = document.querySelector('[name="note"]')?.value.trim() || '';

    // L·∫•y voucherCode & voucherDiscount t·ª´ localStorage
    const voucherDiscount = parseInt(localStorage.getItem("voucherDiscount")) || 0;
    const voucherCode     = localStorage.getItem("voucherCode") || '';

    // T√≠nh to√°n th√†nh ti·ªÅn
    const subtotal = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
    const discountAmount = Math.floor(subtotal * voucherDiscount / 100);
    const totalAfterDiscount = subtotal - discountAmount;

    // L·∫•y ƒë·ªãa ch·ªâ (provinceSelect, districtSelect, wardSelect c·∫ßn ƒë∆∞·ª£c x√°c ƒë·ªãnh t·ª´ tr∆∞·ªõc)
    const province = provinceSelect.selectedIndex > 0
      ? provinceSelect.options[provinceSelect.selectedIndex].textContent.trim()
      : '';
    const district = districtSelect.selectedIndex > 0
      ? districtSelect.options[districtSelect.selectedIndex].textContent.trim()
      : '';
    const ward = wardSelect.selectedIndex > 0
      ? wardSelect.options[wardSelect.selectedIndex].textContent.trim()
      : '';

    const fullname = `${first_name} ${last_name}`.trim();
    const address = `${street}, ${ward}, ${district}, ${province}`.trim();
    const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value || "COD";
    // accountId (n·∫øu ƒë√£ login tr√™n server, v√≠ d·ª• EJS render v√†o trang)
    const accountId = "<%= user?.id %>";

    // Ki·ªÉm tra b·∫Øt bu·ªôc
    if (!first_name || !last_name || !email || !phone || !street || !province || !district || !ward) {
      alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·∫∑t h√†ng.");
      return;
    }

    // Ch·ªâ g·ª≠i discount_code (kh√¥ng c√≤n voucher_id n·ªØa)
    const orderData = {
      account_id: accountId,
      fullname,
      phone,
      email,
      address,
      note,
      payment_method: paymentMethod,
      total_payment: totalAfterDiscount,
      cartItems: JSON.stringify(cart),
      discount_amount: discountAmount,
      discount_code: voucherCode   // <-- g·ª≠i ƒë√∫ng bi·∫øn ƒë√£ l∆∞u
      // voucher_id ƒë√£ b·ªã lo·∫°i b·ªè
    };

    console.log("üöÄ D·ªØ li·ªáu g·ª≠i ƒëi:", orderData);

    try {
      const response = await fetch("/api/order/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(orderData)
      });

      if (!response.ok) throw new Error("ƒê·∫∑t h√†ng th·∫•t b·∫°i");
      const result = await response.json();

      // Sau khi t·∫°o xong ƒë∆°n, x√≥a localStorage
      localStorage.removeItem("cart");
      localStorage.removeItem("voucherDiscount");
      localStorage.removeItem("voucherCode");

      if (paymentMethod === "MoMo") {
        window.location.href = result.payUrl;
      } else {
        // Chuy·ªÉn t·ªõi trang th√†nh c√¥ng n·∫øu c·∫ßn
        window.location.href = "/success";
      }
    } catch (err) {
      alert("‚ùå L·ªói g·ª≠i ƒë∆°n h√†ng: " + err.message);
    }
  });
}
});
</script>






</body>

</html>